

name: Smart Caddy Docker Build

on:
  schedule:
    - cron: "0 0 * * *"   # Daily at midnight UTC
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------
      # ðŸ” CHECK FOR UPDATES
      # -------------------------------
      - name: Check Caddy + Plugin Updates
        id: versions
        run: |
          echo "Checking latest versions..."

          CADDY_VERSION=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest | jq -r .tag_name)

          PORKBUN_SHA=$(curl -s https://api.github.com/repos/caddy-dns/porkbun/commits/main | jq -r .sha)
          ADMIN_SHA=$(curl -s https://api.github.com/repos/gsmlg-dev/caddy-admin-ui/commits/main | jq -r .sha)
          GEO_SHA=$(curl -s https://api.github.com/repos/porech/caddy-maxmind-geolocation/commits/main | jq -r .sha)

          echo "CADDY_VERSION=$CADDY_VERSION" >> $GITHUB_ENV
          echo "PORKBUN_SHA=$PORKBUN_SHA" >> $GITHUB_ENV
          echo "ADMIN_SHA=$ADMIN_SHA" >> $GITHUB_ENV
          echo "GEO_SHA=$GEO_SHA" >> $GITHUB_ENV

      # -------------------------------
      # ðŸ“¦ RESTORE LAST BUILD CACHE
      # -------------------------------
      - name: Restore Version Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: build_versions.env
          key: caddy-build-versions

      # -------------------------------
      # ðŸ§  COMPARE WITH LAST BUILD
      # -------------------------------
      - name: Compare Versions
        id: compare
        run: |
          BUILD_NEEDED=false

          if [ -f build_versions.env ]; then
            source build_versions.env
          fi

          if [ "$CADDY_VERSION" != "$LAST_CADDY" ]; then BUILD_NEEDED=true; fi
          if [ "$PORKBUN_SHA" != "$LAST_PORKBUN" ]; then BUILD_NEEDED=true; fi
          if [ "$ADMIN_SHA" != "$LAST_ADMIN" ]; then BUILD_NEEDED=true; fi
          if [ "$GEO_SHA" != "$LAST_GEO" ]; then BUILD_NEEDED=true; fi

          echo "BUILD_NEEDED=$BUILD_NEEDED" >> $GITHUB_ENV

      - name: Stop if nothing changed
        if: env.BUILD_NEEDED == 'false'
        run: echo "âœ… No updates detected. Skipping build."

      # -------------------------------
      # ðŸ³ DOCKER SETUP (ONLY IF BUILD)
      # -------------------------------
      - name: Set up QEMU
        if: env.BUILD_NEEDED == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: env.BUILD_NEEDED == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: env.BUILD_NEEDED == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set date tag
        if: env.BUILD_NEEDED == 'true'
        run: echo "DATE_TAG=$(date +%Y%m%d)" >> $GITHUB_ENV

      # -------------------------------
      # ðŸ— BUILD & PUSH
      # -------------------------------
      - name: Build and Push Image
        if: env.BUILD_NEEDED == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            srstone/caddy-porkbun:${{ env.CADDY_VERSION }}-${{ env.DATE_TAG }}
            srstone/caddy-porkbun:latest

      # -------------------------------
      # ðŸ’¾ SAVE CURRENT VERSIONS
      # -------------------------------
      - name: Save Build Versions
        if: env.BUILD_NEEDED == 'true'
        run: |
          echo "LAST_CADDY=${{ env.CADDY_VERSION }}" > build_versions.env
          echo "LAST_PORKBUN=${{ env.PORKBUN_SHA }}" >> build_versions.env
          echo "LAST_ADMIN=${{ env.ADMIN_SHA }}" >> build_versions.env
          echo "LAST_GEO=${{ env.GEO_SHA }}" >> build_versions.env

